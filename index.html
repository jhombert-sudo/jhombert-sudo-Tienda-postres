<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>üßÅQ‚ÄôBocao</title>
  <meta name="description" content="Tienda de postres: filtros, sabores, carrito con WhatsApp, env√≠o por distancia y checkout." />
  <style>
    /* === TEMA: VAINILLA CREMA (claro pastel) === */
    :root{
      --bg:#fffaf3;         /* fondo base crema */
      --bg-2:#fff2e1;       /* degradado sutil */
      --card:#ffffff;       /* tarjetas y controles */
      --ink:#171717;        /* texto principal (negro c√°lido) */
      --muted:#6b7280;      /* texto secundario gris suave */
      --accent:#ffd5e2;     /* rosa claro */
      --accent-2:#ff9fbf;   /* rosa medio */
      --accent-3:#ff7aa6;   /* rosa vivo (hover) */
      --ok:#22c55e;
      --border:rgba(255,159,191,.35);
      --overlay:rgba(255,255,255,.75);
      --chip-bg:rgba(255,159,191,.08);
      --chip-bd:rgba(255,159,191,.35);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";
      color:var(--ink);
      background:
        radial-gradient(900px 500px at -10% -20%, rgba(255,159,191,.12), transparent 60%),
        radial-gradient(600px 420px at 110% -10%, rgba(255,213,226,.18), transparent 60%),
        linear-gradient(180deg, var(--bg-2) 0%, var(--bg) 60%, #fff 100%);
      min-height:100svh;
    }
    header{
      position:sticky; top:0; z-index:30;
      backdrop-filter:saturate(1.2) blur(8px);
      background:rgba(255,255,255,.70);
      border-bottom:1px solid var(--border)
    }
    .wrap{max-width:1100px; margin:auto; padding:18px}
    .brand{display:flex; align-items:center; gap:12px}

    .logo{
      width:40px; height:40px; border-radius:12px; display:grid; place-items:center;
      background:
        radial-gradient(120px 80px at 30% 20%, var(--accent-2), transparent),
        radial-gradient(120px 80px at 70% 80%, var(--accent), transparent);
      box-shadow:0 6px 30px rgba(255,159,191,.35);
      position:relative;
    }
    .logo-wrap{ display:flex; flex-direction:column; align-items:center; gap:4px; min-width:40px; }
    .tagline{ font-size:10px; line-height:1; color:var(--muted); white-space:nowrap; letter-spacing:.2px; user-select:none; }

    /* Pastel del logo girando */
    .logo-emoji{
      display:grid; place-items:center; font-size:20px;
      transform-origin:50% 55%;
      animation: logo-spin 9s linear infinite;
      will-change: transform;
    }
    .logo:hover .logo-emoji{ animation-play-state: paused; }
    @media (prefers-reduced-motion: reduce){ .logo-emoji{ animation:none; } }
    @keyframes logo-spin { to{ transform: rotate(360deg); } }

    h1{font-size:clamp(20px,3vw,28px); margin:0}

    .toolbar{display:grid; grid-template-columns:auto 1fr; align-items:center; gap:12px; margin-top:14px}
    .filters{display:flex; gap:8px; flex-wrap:wrap}
    .btn,.input,select,textarea{
      border:1px solid var(--chip-bd); background:var(--card); color:var(--ink);
      padding:10px 12px; border-radius:12px; cursor:pointer; font:inherit
    }
    .input,textarea,select{cursor:text}
    .btn:hover,select:hover{border-color:var(--accent-3)}
    .btn.active{background:linear-gradient(135deg, rgba(255,149,182,.20), rgba(255,193,211,.10)); border-color:var(--accent-2)}
    .distance{color:var(--muted); font-size:14px; display:flex; gap:8px; align-items:center; flex-wrap:wrap}
    .badge{border:1px solid var(--border); border-radius:999px; padding:6px 10px; background:var(--card)}

    main{padding:18px}
    .grid{--min:240px; display:grid; grid-template-columns:repeat(auto-fill,minmax(var(--min),1fr)); gap:16px; max-width:1100px; margin:18px auto}
    .card{background:var(--card); border:1px solid rgba(255,159,191,.28); border-radius:16px; overflow:hidden; display:flex; flex-direction:column; box-shadow:0 10px 30px rgba(0,0,0,.08); perspective:900px}
    .card .tilt{transform-style:preserve-3d; transition: transform .25s ease}
    .card picture{display:block; aspect-ratio:16/11; background:#fafafa; overflow:hidden; border-bottom:1px solid rgba(255,159,191,.28)}
    .card img{width:100%; height:100%; object-fit:cover; display:block; transition:transform .5s ease}
    .card:hover img{transform:scale(1.06)}
    .card .body{padding:14px}
    .title{font-size:18px; margin:0 0 6px; display:flex; justify-content:space-between; align-items:center}
    .qty-badge{font-size:12px; color:var(--muted); border:1px solid var(--border); padding:2px 8px; border-radius:999px}
    .meta{display:flex; justify-content:space-between; align-items:center; color:var(--muted); font-size:14px}
    .price{color:var(--accent-2); font-weight:700}
    .flavors{margin-top:8px; display:flex; gap:6px; flex-wrap:wrap}
    .chip{font-size:12px; padding:6px 10px; border:1px solid var(--chip-bd); border-radius:999px; color:var(--muted); background:var(--chip-bg); cursor:pointer}
    .chip.active{color:var(--ink); background:linear-gradient(135deg, rgba(255,149,182,.28), rgba(255,193,211,.12)); border-color:var(--accent-2)}
    .actions{display:flex; gap:8px; margin-top:12px}
    .actions .btn{flex:1}
    .actions .add{background:linear-gradient(135deg, rgba(255,149,182,.28), rgba(255,193,211,.12)); border-color:var(--accent-2)}

    .cart{position:fixed; right:18px; bottom:18px; display:flex; gap:10px; align-items:center; background:linear-gradient(135deg, rgba(255,149,182,.22), rgba(255,193,211,.10)); border:1px solid rgba(255,159,191,.40); padding:10px 14px; border-radius:16px; box-shadow:0 10px 30px rgba(0,0,0,.12); flex-wrap:wrap; z-index:40}
    .cart small{color:var(--muted)}
    .cart .count{font-weight:700; color:var(--accent-2)}
    .cart .total{font-weight:700}
    .wa{background:transparent; border:1px solid var(--ok); color:var(--ink); padding:10px 12px; border-radius:12px; cursor:pointer}
    .wa:hover{background:rgba(34,197,94,.12)}
    .clear{border-color:#ef4444}
    .clear:hover{background:rgba(239,68,68,.12)}

    footer{border-top:1px solid var(--border); margin-top:30px}
    footer .wrap{display:flex; justify-content:center; padding:18px}
    footer .brand{font-weight:700; letter-spacing:.5px}

    .empty{grid-column:1/-1; text-align:center; color:var(--muted); padding:30px; border:1px dashed var(--chip-bd); border-radius:16px}

    /* Modal */
    .modal{position:fixed; inset:0; display:none; place-items:center; z-index:50}
    .modal.open{display:grid}
    .overlay{position:absolute; inset:0; background:var(--overlay); backdrop-filter: blur(5px)}
    .dialog{position:relative; width:min(720px,92vw); max-height:85vh; overflow:auto; background:var(--card); border:1px solid var(--chip-bd); border-radius:16px; box-shadow:0 20px 60px rgba(0,0,0,.10); padding:16px}
    .dialog h3{margin:0 0 8px}
    .dialog .grid2{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    .dialog .grid3{display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px}
    .row{display:grid; gap:6px}
    label{font-size:12px; color:var(--muted)}
    .err{color:#ff6b6b; font-size:12px}
    .dialog .bar{display:flex; justify-content:flex-end; gap:8px; padding-top:10px}
    .x{position:absolute; top:8px; right:8px; border:1px solid var(--chip-bd); background:transparent; color:var(--ink); border-radius:10px; padding:6px 10px; cursor:pointer}
    .paybox{border:1px dashed var(--chip-bd); border-radius:12px; padding:10px; display:flex; gap:8px; align-items:center; flex-wrap:wrap}
    .copy{border:1px solid var(--chip-bd); border-radius:10px; padding:6px 10px; background:transparent; color:var(--ink); cursor:pointer}

    /* Toast siempre arriba */
    .toast{
      position:fixed;
      left:50%;
      bottom:calc(env(safe-area-inset-bottom, 0px) + 20px);
      transform:translateX(-50%);
      background:rgba(0,0,0,.8);
      color:#fff;
      padding:10px 14px;
      border-radius:10px;
      display:none;
      z-index:9999;           /* por encima de todo */
      pointer-events:none;    /* no bloquea clicks */
    }

    /* Mobile */
    @media (max-width: 960px){
      .toolbar{grid-template-columns:1fr}
      .grid{--min:170px}
      .cart{left:12px; right:12px}
    }
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="brand">
        <div class="logo-wrap">
          <div class="logo"><span class="logo-emoji" aria-hidden>üç∞</span></div>
          <span class="tagline">Hecho para tentarte</span>
        </div>
        <h1>Q‚ÄôBocao</h1>
      </div>

      <div class="toolbar">
        <!-- Filtros -->
        <div class="filters" role="group" aria-label="Filtros de categor√≠a">
          <button class="btn active" data-cat="all" aria-pressed="true">Todos</button>
          <button class="btn" data-cat="tortas" aria-pressed="false">Tortas</button>
          <button class="btn" data-cat="pasteleria" aria-pressed="false">Pasteler√≠a</button>
        </div>

        <!-- Zona + badges -->
        <div class="filters" style="justify-content:flex-end; gap:10px">
          <select id="zoneSelect" title="Cambiar zona">
            <option value="auto">Zona autom√°tica</option>
            <option value="retira">Retiro en local</option>
            <option value="z1">0‚Äì3 km</option>
            <option value="z2">3‚Äì6 km</option>
            <option value="z3">6‚Äì10 km</option>
          </select>
          <div class="distance">
            <span class="badge" id="distanceBadge">Distancia: ‚Äî</span>
            <span class="badge" id="zoneBadge">Zona: Retiro en local</span>
            <span class="badge" id="feeBadge">Env√≠o: $0</span>
          </div>
        </div>
      </div>
    </div>
  </header>

  <main>
    <section class="grid" id="grid" aria-live="polite"></section>
  </main>

  <div class="cart" aria-live="polite">
    <small><span class="count" id="cartCount">0</span> √≠tems</small>
    <small>Subtotal: <span id="subTotal">$0</span> ¬∑ Env√≠o: <span id="shipFee">$0</span></small>
    <span class="total" id="grandTotal">$0</span>
    <button class="btn clear" id="clearBtn" title="Vaciar carrito">Vaciar</button>
    <button class="wa" id="waBtn">Enviar pedido por WhatsApp</button>
  </div>

  <footer>
    <div class="wrap">
      <span class="brand">JUCA¬Æ</span>
    </div>
  </footer>

  <!-- Modal Checkout -->
  <div class="modal" id="checkoutModal" aria-hidden="true" role="dialog" aria-labelledby="chkTitle" aria-modal="true">
    <div class="overlay" id="overlay"></div>
    <div class="dialog">
      <button class="x" id="closeModal" aria-label="Cerrar">‚úï</button>
      <h3 id="chkTitle">Datos para la entrega</h3>

      <div class="grid2">
        <div class="row">
          <label for="nombre">Nombre y apellido *</label>
          <input class="input" id="nombre" autocomplete="name" placeholder="Ej.: Ana P√©rez" />
          <span class="err" id="e-nombre"></span>
        </div>
        <div class="row">
          <label for="localidad">Localidad *</label>
          <input class="input" id="localidad" placeholder="Ej.: Liniers" />
          <span class="err" id="e-localidad"></span>
        </div>
      </div>

      <div class="grid3">
        <div class="row">
          <label for="calle">Calle *</label>
          <input class="input" id="calle" placeholder="Ej.: Irigoyen" />
          <span class="err" id="e-calle"></span>
        </div>
        <div class="row">
          <label for="altura">Altura *</label>
          <input class="input" id="altura" inputmode="numeric" placeholder="Ej.: 1234" />
          <span class="err" id="e-altura"></span>
        </div>
        <div class="row">
          <label for="cp">C√≥digo postal *</label>
          <input class="input" id="cp" placeholder="Ej.: 1408 o C1001ABC" />
          <span class="err" id="e-cp"></span>
        </div>
      </div>

      <div class="grid2">
        <div class="row">
          <label>Tipo de domicilio *</label>
          <div style="display:flex; gap:8px; flex-wrap:wrap">
            <label><input type="radio" name="tipo" id="tipoCasa" value="Casa" checked> Casa</label>
            <label><input type="radio" name="tipo" id="tipoDepto" value="Departamento"> Departamento</label>
          </div>
          <span class="err" id="e-tipo"></span>
        </div>
        <div class="grid2" id="deptoFields" style="display:none">
          <div class="row">
            <label for="piso">Piso *</label>
            <input class="input" id="piso" placeholder="Ej.: 3" />
            <span class="err" id="e-piso"></span>
          </div>
          <div class="row">
            <label for="depto">Departamento *</label>
            <input class="input" id="depto" placeholder="Ej.: B" />
            <span class="err" id="e-depto"></span>
          </div>
        </div>
      </div>

      <!-- M√âTODO DE PAGO (en el modal) -->
      <div class="row">
        <label>M√©todo de pago *</label>
        <div style="display:flex; gap:12px; flex-wrap:wrap">
          <label><input type="radio" name="pago" id="payEfectivo" value="efectivo" checked> Efectivo</label>
          <label><input type="radio" name="pago" id="payTransfer" value="transferencia"> Transferencia</label>
        </div>
      </div>

      <!-- Si eligen efectivo -->
      <div class="row" id="cashRow">
        <label for="cashChange">¬øLlevamos cambio? (opcional)</label>
        <input class="input" id="cashChange" type="number" min="0" inputmode="numeric" placeholder="Ej.: 10000" />
      </div>

      <!-- Si eligen transferencia -->
      <div class="row" id="transferRow" style="display:none">
        <label>Datos para transferir</label>
        <div class="paybox">
          <span class="hint">Alias: <strong id="aliasText">jhomberthuniel</strong></span>
          <button class="copy" data-copy="alias">Copiar alias</button>
          <span class="hint">CBU: <strong id="cbuText">0000003100013610446016</strong></span>
          <button class="copy" data-copy="cbu">Copiar CBU</button>
        </div>
      </div>

      <div class="row">
        <label for="indicaciones">Indicaciones para el repartidor (opcional)</label>
        <textarea class="input" id="indicaciones" rows="3" placeholder="Ej.: Timbre roto, llamar al llegar."></textarea>
      </div>

      <div class="row">
        <label for="horario">Horario preferido (opcional)</label>
        <input class="input" id="horario" placeholder="Ej.: 18 a 20 hs" />
      </div>

      <div class="bar">
        <button class="btn" id="cancelModal">Cancelar</button>
        <button class="wa" id="confirmCheckout">Confirmar y abrir WhatsApp</button>
      </div>
    </div>
  </div>

  <div class="toast" id="toast">Copiado ‚úÖ</div>

  <script>
  // ‚Äî‚Äî‚Äî Configuraci√≥n ‚Äî‚Äî‚Äî
  const CONFIG = {
    STORE_LAT: -34.6335848,
    STORE_LNG: -58.5979308,
    PHONE: '5491154815519',
    CURRENCY: 'ARS',
    ZONES: {
      retira: {name:'Retiro en local', fee:0},
      z1: {name:'0‚Äì3 km', fee:1500},
      z2: {name:'3‚Äì6 km', fee:2500},
      z3: {name:'6‚Äì10 km', fee:3500}
    },
    PAY: {
      alias: 'jhomberthuniel',
      cbu: '0000003100013610446016'
    }
  };

  // ‚Äî‚Äî‚Äî Cat√°logo ‚Äî‚Äî‚Äî
  const CATALOG = [
    { id:"ck1", nombre:"Cheesecake de chocolate", precio: 6200, cat:"tortas",   img:"https://source.unsplash.com/DOWsiEekKIA" },
    { id:"ck4", nombre:"Cheesecake de cereza",    precio: 5900, cat:"tortas",   img:"https://source.unsplash.com/YLMjArY4048" },
    { id:"ck7", nombre:"Cheesecake rosa",         precio: 6000, cat:"tortas",   img:"https://source.unsplash.com/FDYbS43jUrU" },
    { id:"ck8", nombre:"Cheesecake cl√°sico",      precio: 5700, cat:"tortas",   img:"https://source.unsplash.com/vx4UkYTzl0w" },
    { id:"ck5", nombre:"Pastelitos azucarados",   precio: 2400, cat:"pasteleria", img:"https://source.unsplash.com/R3RwPzTakCU" }
  ];

  const FLAVORS = ['chocolate','frutilla'];
  const selectedFlavor = new Map();
  const state = {
    cat:"all",
    cart:new Map(),
    zone:"retira",
    zoneMode:"auto"
  };

  // ‚Äî‚Äî‚Äî Elementos ‚Äî‚Äî‚Äî
  const $grid = document.getElementById('grid');
  const $waBtn = document.getElementById('waBtn');
  const $clearBtn = document.getElementById('clearBtn');
  const $cartCount = document.getElementById('cartCount');
  const $subTotal = document.getElementById('subTotal');
  const $shipFee = document.getElementById('shipFee');
  const $grandTotal = document.getElementById('grandTotal');
  const $distanceBadge = document.getElementById('distanceBadge');
  const $zoneBadge = document.getElementById('zoneBadge');
  const $feeBadge = document.getElementById('feeBadge');
  const $zoneSelect = document.getElementById('zoneSelect');

  // Modal
  const $modal = document.getElementById('checkoutModal');
  const $overlay = document.getElementById('overlay');
  const $closeModal = document.getElementById('closeModal');
  const $cancelModal = document.getElementById('cancelModal');
  const $confirmCheckout = document.getElementById('confirmCheckout');

  // Form fields
  const $nombre = document.getElementById('nombre');
  const $localidad = document.getElementById('localidad');
  const $calle = document.getElementById('calle');
  const $altura = document.getElementById('altura');
  const $cp = document.getElementById('cp');
  const $tipoCasa = document.getElementById('tipoCasa');
  const $tipoDepto = document.getElementById('tipoDepto');
  const $deptoFields = document.getElementById('deptoFields');
  const $piso = document.getElementById('piso');
  const $depto = document.getElementById('depto');
  const $indicaciones = document.getElementById('indicaciones');
  const $horario = document.getElementById('horario');

  // Pago en modal
  const $payEfectivo = document.getElementById('payEfectivo');
  const $payTransfer = document.getElementById('payTransfer');
  const $cashRow = document.getElementById('cashRow');
  const $cashChange = document.getElementById('cashChange');
  const $transferRow = document.getElementById('transferRow');

  const $toast = document.getElementById('toast');

  // ‚Äî‚Äî‚Äî Inicio ‚Äî‚Äî‚Äî
  loadCart();
  loadCheckoutDraft();
  render();
  ensureGeoPermissionThenTry();  // <= geolocalizaci√≥n con manejo de permiso
  updateTotals();
  setupModalPayControls();
  setupTilt();

  // ‚Äî‚Äî‚Äî Eventos generales ‚Äî‚Äî‚Äî
  document.querySelectorAll('[data-cat]').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('[data-cat]').forEach(b => { b.classList.remove('active'); b.setAttribute('aria-pressed','false'); });
      btn.classList.add('active'); btn.setAttribute('aria-pressed','true');
      state.cat = btn.dataset.cat;
      render();
    });
  });

  // Abrir modal
  $waBtn.addEventListener('click', () => {
    if(!state.cart.size){
      alert('Tu carrito est√° vac√≠o. Eleg√≠ al menos un postre.');
      return;
    }
    openModal();
  });

  // Vaciar
  $clearBtn.addEventListener('click', () => {
    if(confirm('¬øVaciar el carrito?')){
      state.cart.clear();
      persistCart();
      updateCartCount();
      updateTotals();
      render();
    }
  });

  // Zona
  $zoneSelect.addEventListener('change', () => {
    const v = $zoneSelect.value;
    if(v === 'auto'){
      state.zoneMode = 'auto';
      ensureGeoPermissionThenTry();
    }else{
      state.zoneMode = 'manual';
      state.zone = v;
      updateTotals();
      $zoneBadge.textContent = `Zona: ${CONFIG.ZONES[state.zone]?.name || 'Retiro en local'}`;
    }
  });

  // Copiar alias/CBU (dentro del modal)
  document.addEventListener('click', async (e)=>{
    const btn = e.target.closest('.copy');
    if(!btn) return;
    const what = btn.dataset.copy;
    const text = what==='alias' ? CONFIG.PAY.alias : CONFIG.PAY.cbu;
    try{ await navigator.clipboard.writeText(text); showToast('Copiado ‚úÖ'); }catch(e){ showToast('No se pudo copiar'); }
  });

  // Modal interactions
  $tipoCasa.addEventListener('change', ()=> toggleDepto(false));
  $tipoDepto.addEventListener('change', ()=> toggleDepto(true));
  $overlay.addEventListener('click', closeModal);
  $closeModal.addEventListener('click', closeModal);
  $cancelModal.addEventListener('click', closeModal);
  document.addEventListener('keydown', (e)=>{ if(e.key==='Escape' && $modal.classList.contains('open')) closeModal(); });

  $confirmCheckout.addEventListener('click', () => {
    const data = validateCheckout();
    if(!data) return;
    // Pago elegido en el modal
    data.pay = $payTransfer.checked ? 'transferencia' : 'efectivo';
    data.cashChange = Math.max(0, Number($cashChange.value || 0));
    persistCheckoutDraft(data);
    openWhatsAppWith(data);
    closeModal();
  });

  // ‚Äî‚Äî‚Äî Render de productos ‚Äî‚Äî‚Äî
  function render(){
    const list = CATALOG.filter(p => state.cat==='all' ? true : p.cat===state.cat);
    $grid.innerHTML = '';
    if(!list.length){
      $grid.innerHTML = `<div class="empty">No encontramos nada con esos filtros. Prob√° cambiar la categor√≠a üçÆ</div>`;
      return;
    }
    list.forEach(p => $grid.appendChild(card(p)));
  }

  function card(p){
    if(!selectedFlavor.get(p.id)) selectedFlavor.set(p.id, FLAVORS[0]);

    const el = document.createElement('article');
    el.className = 'card';
    el.innerHTML = `
      <div class="tilt">
        <picture><img loading="lazy" alt="${escapeHtml(p.nombre)}" src="${p.img}"/></picture>
      </div>
      <div class="body">
        <h3 class="title">
          <span>${escapeHtml(p.nombre)}</span>
          <span class="qty-badge" id="qty-${p.id}">${getQty(p.id, selectedFlavor.get(p.id)) || 0}</span>
        </h3>
        <div class="meta">
          <span class="price">${money(p.precio)}</span>
          <span>${prettyCat(p.cat)}</span>
        </div>
        <div class="flavors" role="group" aria-label="Elegir sabor">
          ${FLAVORS.map(f => `<button class="chip ${f===selectedFlavor.get(p.id)?'active':''}" data-flavor="${f}" aria-pressed="${f===selectedFlavor.get(p.id)}">${cap(f)}</button>`).join('')}
        </div>
        <div class="actions">
          <button class="btn add" data-id="${p.id}">Agregar</button>
          <button class="btn remove" data-id="${p.id}">Quitar</button>
        </div>
      </div>`;

    const tilt = el.querySelector('.tilt');
    setupTiltFor(tilt);

    // sabores
    el.querySelectorAll('.chip').forEach(ch => {
      ch.addEventListener('click', () => {
        el.querySelectorAll('.chip').forEach(x=>{x.classList.remove('active'); x.setAttribute('aria-pressed','false');});
        ch.classList.add('active'); ch.setAttribute('aria-pressed','true');
        selectedFlavor.set(p.id, ch.dataset.flavor);
        el.querySelector('#qty-'+p.id).textContent = getQty(p.id, ch.dataset.flavor) || 0;
      });
    });

    // agregar / quitar
    el.querySelector('.add').addEventListener('click', () => {
      addToCart(p.id, selectedFlavor.get(p.id), +1);
      el.querySelector('#qty-'+p.id).textContent = getQty(p.id, selectedFlavor.get(p.id));
    });
    el.querySelector('.remove').addEventListener('click', () => {
      addToCart(p.id, selectedFlavor.get(p.id), -1);
      el.querySelector('#qty-'+p.id).textContent = getQty(p.id, selectedFlavor.get(p.id)) || 0;
    });

    return el;
  }

  // ‚Äî‚Äî‚Äî Carrito ‚Äî‚Äî‚Äî
  function addToCart(id, sabor, delta){
    const prod = CATALOG.find(x=>x.id===id);
    if(!prod || !delta) return;
    const key = id + '__' + sabor;
    const cur = state.cart.get(key) || { ...prod, sabor, qty:0 };
    cur.qty += delta;
    if(cur.qty <= 0){ state.cart.delete(key); }
    else { state.cart.set(key, cur); }
    persistCart();
    updateCartCount();
    updateTotals();
  }
  function getQty(id, sabor){
    const item = state.cart.get(id + '__' + sabor);
    return item ? item.qty : 0;
  }
  function updateCartCount(){
    $cartCount.textContent = [...state.cart.values()].reduce((a,i)=>a+i.qty,0);
  }
  function persistCart(){
    try{
      const plain = [...state.cart.values()].map(i => ({id:i.id, nombre:i.nombre, precio:i.precio, cat:i.cat, img:i.img, sabor:i.sabor, qty:i.qty}));
      localStorage.setItem('qbocao_cart_v1', JSON.stringify(plain));
    }catch(e){}
  }
  function loadCart(){
    try{
      const raw = localStorage.getItem('qbocao_cart_v1');
      if(!raw) return;
      const arr = JSON.parse(raw);
      state.cart = new Map(arr.map(i => [i.id+'__'+i.sabor, i]));
      updateCartCount();
    }catch(e){}
  }

  // ‚Äî‚Äî‚Äî Utilidades ‚Äî‚Äî‚Äî
  function prettyCat(c){ return c==='tortas' ? 'Torta' : 'Pasteler√≠a'; }
  function cap(s){ return s.charAt(0).toUpperCase() + s.slice(1); }
  function money(n){
    return new Intl.NumberFormat('es-AR',{style:'currency',currency:CONFIG.CURRENCY,maximumFractionDigits:0}).format(n);
  }
  function calcTotals(){
    const subtotal = [...state.cart.values()].reduce((a,i)=>a+i.precio*i.qty,0);
    const fee = CONFIG.ZONES[state.zone]?.fee || 0;
    const total = subtotal + fee;
    return {subtotal, fee, total};
  }
  function updateTotals(){
    const {subtotal, fee, total} = calcTotals();
    $subTotal.textContent = money(subtotal);
    $shipFee.textContent = money(fee);
    $grandTotal.textContent = money(total);
    $feeBadge.textContent = `Env√≠o: ${money(fee)}`;
    $zoneBadge.textContent = `Zona: ${CONFIG.ZONES[state.zone]?.name || 'Retiro en local'}`;
  }

  // ‚Äî‚Äî‚Äî Distancia (auto) + permiso ‚Äî‚Äî‚Äî
  async function ensureGeoPermissionThenTry(){
    try{
      if(navigator.permissions && navigator.permissions.query){
        const perm = await navigator.permissions.query({name:'geolocation'});
        if(perm.state === 'denied'){
          $distanceBadge.textContent = 'Distancia: permiso denegado';
          state.zone = 'retira'; updateTotals();
          return;
        }
        perm.onchange = () => { if(perm.state === 'granted') tryAutoDistance(); };
      }
      await tryAutoDistance();
    }catch(e){
      $distanceBadge.textContent = 'Distancia: ‚Äî';
    }
  }

  async function tryAutoDistance(){
    if(state.zoneMode !== 'auto') return;
    try{
      const pos = await getCurrentPosition({enableHighAccuracy:true, timeout:8000});
      const km = haversineKm(CONFIG.STORE_LAT, CONFIG.STORE_LNG, pos.coords.latitude, pos.coords.longitude);
      applyZoneByKm(km);
      $distanceBadge.textContent = `Distancia: ${km.toFixed(1)} km`;
      $zoneSelect.value = 'auto';
    }catch(e){
      $distanceBadge.textContent = 'Distancia: ‚Äî';
      state.zone = 'retira';
      updateTotals();
    }
  }
  function applyZoneByKm(km){
    if(km < 0.2){ state.zone = 'retira'; }
    else if(km <= 3){ state.zone = 'z1'; }
    else if(km <= 6){ state.zone = 'z2'; }
    else { state.zone = 'z3'; }
    updateTotals();
  }
  function haversineKm(lat1, lon1, lat2, lon2){
    const R = 6371; const toRad = d => d * Math.PI / 180;
    const dLat = toRad(lat2 - lat1), dLon = toRad(lon2 - lon1);
    const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
    return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  }
  function getCurrentPosition(opts={}){
    return new Promise((res, rej) => {
      if(!('geolocation' in navigator)) return rej(new Error('Geolocalizaci√≥n no disponible'));
      navigator.geolocation.getCurrentPosition(res, rej, opts);
    });
  }
  function escapeHtml(s){
    return s.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;', "'":'&#39;'}[m]));
  }

  // ‚Äî‚Äî‚Äî Modal helpers ‚Äî‚Äî‚Äî
  function setupModalPayControls(){
    const toggle = ()=>{
      if($payTransfer.checked){
        $transferRow.style.display = '';
        $cashRow.style.display = 'none';
      }else{
        $transferRow.style.display = 'none';
        $cashRow.style.display = '';
      }
    };
    $payEfectivo.addEventListener('change', toggle);
    $payTransfer.addEventListener('change', toggle);
    toggle(); // estado inicial
  }
  function openModal(){
    $modal.classList.add('open');
    $modal.setAttribute('aria-hidden','false');
    document.body.style.overflow='hidden';
    $nombre.focus({preventScroll:true});
  }
  function closeModal(){
    $modal.classList.remove('open');
    $modal.setAttribute('aria-hidden','true');
    document.body.style.overflow='';
  }
  function toggleDepto(show){
    $deptoFields.style.display = show ? '' : 'none';
  }
  function validateCheckout(){
    ['nombre','localidad','calle','altura','cp','piso','depto'].forEach(k => setErr(k,''));
    let ok = true;

    const data = {
      nombre: $nombre.value.trim(),
      localidad: $localidad.value.trim(),
      calle: $calle.value.trim(),
      altura: $altura.value.trim(),
      cp: ($cp.value || '').trim().toUpperCase(),
      tipo: $tipoDepto.checked ? 'Departamento' : 'Casa',
      piso: $tipoDepto.checked ? ($piso.value || '').trim() : '',
      depto: $tipoDepto.checked ? ($depto.value || '').trim() : '',
      indicaciones: $indicaciones.value.trim(),
      horario: $horario.value.trim()
    };

    if(!data.nombre){ ok=false; setErr('nombre','Ingres√° tu nombre y apellido.'); }
    if(!data.localidad){ ok=false; setErr('localidad','Ingres√° tu localidad.'); }
    if(!data.calle){ ok=false; setErr('calle','Ingres√° la calle.'); }
    if(!/^\d{1,5}$/.test(data.altura)){ ok=false; setErr('altura','Altura inv√°lida.'); }
    if(!/^\d{4}$/.test(data.cp) && !/^[A-Z]\d{4}[A-Z]{3}$/.test(data.cp)){ ok=false; setErr('cp','C√≥digo postal inv√°lido.'); }
    if(data.tipo==='Departamento'){
      if(!data.piso){ ok=false; setErr('piso','Indic√° el piso.'); }
      if(!data.depto){ ok=false; setErr('depto','Indic√° el departamento.'); }
    }
    return ok ? data : null;
  }
  function setErr(key,msg){
    const el = document.getElementById('e-'+key);
    if(el) el.textContent = msg || '';
  }
  function persistCheckoutDraft(d){
    try{ localStorage.setItem('qbocao_checkout_v1', JSON.stringify(d)); }catch(e){}
  }
  function loadCheckoutDraft(){
    try{
      const raw = localStorage.getItem('qbocao_checkout_v1');
      if(!raw) return;
      const d = JSON.parse(raw);
      $nombre.value = d.nombre || '';
      $localidad.value = d.localidad || '';
      $calle.value = d.calle || '';
      $altura.value = d.altura || '';
      $cp.value = d.cp || '';
      if(d.tipo === 'Departamento'){ $tipoDepto.checked = true; toggleDepto(true); $piso.value = d.piso || ''; $depto.value = d.depto || ''; }
      $indicaciones.value = d.indicaciones || '';
      $horario.value = d.horario || '';
    }catch(e){}
  }

  // ‚Äî‚Äî‚Äî WhatsApp con pago dentro de "Datos del cliente" ‚Äî‚Äî‚Äî
  function openWhatsAppWith(d){
    const items = [...state.cart.values()]
      .map(i => `‚Ä¢ ${i.nombre} (${i.sabor}) x${i.qty} ‚Äî ${money(i.precio*i.qty)}`)
      .join('\n');

    const {subtotal, fee, total} = calcTotals();
    const zoneName = CONFIG.ZONES[state.zone]?.name || 'Retiro en local';

    const pagoLine = d.pay === 'efectivo'
      ? `Efectivo${d.cashChange>0 ? ` (traer cambio de ${money(d.cashChange)})` : ''}`
      : `Transferencia
Alias: ${CONFIG.PAY.alias}
CBU: ${CONFIG.PAY.cbu}`;

    const esDepto = d.tipo === 'Departamento';

    const datosCliente = [
      'Datos del cliente:',
      `Nombre y apellido: ${d.nombre}`,
      `Localidad: ${d.localidad}`,
      `Calle y altura: ${d.calle} ${d.altura}`,
      `C√≥digo postal: ${d.cp}`,
      `Tipo: ${d.tipo}` + (esDepto ? `\nPiso: ${d.piso}\nDepto: ${d.depto}` : ''),
      `Pago: ${pagoLine}`,
      d.indicaciones ? `Indicaciones: ${d.indicaciones}` : '',
      d.horario ? `Horario preferido: ${d.horario}` : ''
    ].filter(Boolean).join('\n');

    const msg =
`Hola, quiero hacer este pedido:

${items}

Env√≠o: ${zoneName} ‚Äî ${money(fee)}
Subtotal: ${money(subtotal)}
Total: ${money(total)}

${datosCliente}`;

    const encoded = encodeURIComponent(msg);
    window.open(`https://wa.me/${CONFIG.PHONE}?text=${encoded}`,'_blank');
  }

  // ‚Äî‚Äî‚Äî Tilt 3D ‚Äî‚Äî‚Äî
  function setupTilt(){
    document.addEventListener('mousemove', (e)=>{
      document.querySelectorAll('.card .tilt').forEach(el=>{
        if(!isInViewport(el) || !el._hovering) return;
        const r = el.getBoundingClientRect();
        const px = (e.clientX - r.left) / r.width;
        const py = (e.clientY - r.top) / r.height;
        const rx = (0.5 - py) * 10;
        const ry = (px - 0.5) * 12;
        el.style.transform = `rotateX(${rx}deg) rotateY(${ry}deg)`;
      });
    });
    document.addEventListener('mouseleave', ()=>resetAllTilt(), true);
  }
  function setupTiltFor(tilt){
    tilt.addEventListener('mouseenter', ()=>{ tilt._hovering = true; });
    tilt.addEventListener('mouseleave', ()=>{ tilt._hovering = false; tilt.style.transform = 'rotateX(0) rotateY(0)'; });
  }
  function resetAllTilt(){
    document.querySelectorAll('.card .tilt').forEach(el=>{
      el._hovering = false; el.style.transform = 'rotateX(0) rotateY(0)';
    });
  }
  function isInViewport(el){
    const r = el.getBoundingClientRect();
    return r.bottom>0 && r.right>0 && r.top < (window.innerHeight||document.documentElement.clientHeight) && r.left < (window.innerWidth||document.documentElement.clientWidth);
  }

  // ‚Äî‚Äî‚Äî Toast ‚Äî‚Äî‚Äî
  let toastTimer;
  function showToast(text){
    $toast.textContent = text || 'Listo';
    $toast.style.display = 'block';
    clearTimeout(toastTimer);
    toastTimer = setTimeout(()=>{ $toast.style.display='none'; }, 1600);
  }
  </script>
</body>
</html>
